# Backend Deployment (VPS)

This guide shows how to deploy the Express + WebSocket + SQLite backend to a Linux VPS behind Nginx, with a systemd service and persistent data/uploads.

## Prerequisites
- Ubuntu 22.04+ (or similar)
- A domain (optional but recommended)
- SSH access with sudo

## 1) Prepare the server

```bash
# Update packages
sudo apt update && sudo apt upgrade -y

# Install Node.js LTS (via NodeSource)
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs build-essential

# Install and enable Nginx
sudo apt install -y nginx
sudo systemctl enable --now nginx

# (Optional) Firewall: allow SSH + HTTP + HTTPS
sudo ufw allow OpenSSH
sudo ufw allow 'Nginx Full'
sudo ufw --force enable

# Create app user (optional)
sudo useradd -m -s /bin/bash app
sudo usermod -aG sudo app
```

## 2) Clone the repo on the server

```bash
# As your deployment user (e.g., app)
sudo -iu app
mkdir -p ~/apps && cd ~/apps

# If repo is public:
# git clone https://github.com/bosscan/sakura-konveksi.git
# If private, set up SSH key and clone via git@...

git clone <YOUR-REPO-URL>.git sakura-konveksi
cd sakura-konveksi

# Install deps (root project)
npm ci
```

## 3) Build frontend and prepare backend

```bash
# Build frontend (Vite)
VITE_API_URL=https://your-domain.com npm run build

# Create runtime directories for backend
mkdir -p backend/runtime/{data,uploads}
```

Notes:
- VITE_API_URL must point to the public base where the backend is exposed (same domain if proxied via Nginx).
- The backend uses SQLite at DATA_DIR/sakura.db and serves files from UPLOAD_DIR.

## 4) Configure environment

Create a file `~/apps/sakura-konveksi/backend/runtime/.env`:

```bash
PORT=4000
DATA_DIR=/home/app/apps/sakura-konveksi/backend/runtime/data
UPLOAD_DIR=/home/app/apps/sakura-konveksi/backend/runtime/uploads
PUBLIC_BASE_URL=https://your-domain.com
# Comma-separated list of allowed origins for CORS
CORS_ORIGIN=https://your-domain.com,https://www.your-domain.com
```

## 5) systemd service

Create `/etc/systemd/system/sakura-backend.service` as root:

```
[Unit]
Description=Sakura Backend (Express + WS)
After=network.target

[Service]
Type=simple
User=app
WorkingDirectory=/home/app/apps/sakura-konveksi
EnvironmentFile=/home/app/apps/sakura-konveksi/backend/runtime/.env
ExecStart=/usr/bin/tsx backend/src/server.ts
Restart=on-failure
RestartSec=3
# Increase file watchers if needed
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
```

Install tsx and enable the service:

```bash
sudo npm i -g tsx
sudo systemctl daemon-reload
sudo systemctl enable --now sakura-backend
sudo systemctl status sakura-backend -n 50
```

If you later add a build step that emits JS (e.g., to `backend/dist/server.js`), you can switch ExecStart to `node backend/dist/server.js`.

## 6) Nginx reverse proxy

Create `/etc/nginx/sites-available/sakura.conf`:

```
server {
  listen 80;
  server_name your-domain.com www.your-domain.com;

  # Optional ACME challenge for certbot
  location /.well-known/acme-challenge/ { root /var/www/html; }

  # Serve frontend build
  root /home/app/apps/sakura-konveksi/dist;
  index index.html;

  # Frontend routes (SPA)
  location / {
    try_files $uri $uri/ /index.html;
  }

  # Backend API & KV
  location /api/ {
    proxy_pass http://127.0.0.1:4000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
  location /kv/ {
    proxy_pass http://127.0.0.1:4000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Uploads (static files generated by backend)
  location /uploads/ {
    proxy_pass http://127.0.0.1:4000;
    proxy_set_header Host $host;
  }

  # WebSocket
  location /ws {
    proxy_pass http://127.0.0.1:4000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 3600s;
  }
}
```

Enable the site and test:

```bash
sudo ln -s /etc/nginx/sites-available/sakura.conf /etc/nginx/sites-enabled/sakura.conf
sudo nginx -t && sudo systemctl reload nginx
```

For HTTPS, run certbot:

```bash
sudo apt install -y certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com -d www.your-domain.com
```

## 7) Deploy updates

On your local machine:

```bash
# commit your work
git add -A
git commit -m "Deployable build"
# push to your remote (GitHub/GitLab)
git push origin master
```

On the server:

```bash
cd ~/apps/sakura-konveksi
git pull --rebase
npm ci
# Build frontend with correct API base
VITE_API_URL=https://your-domain.com npm run build
sudo systemctl restart sakura-backend
```

## 8) Logs and troubleshooting

```bash
# Backend logs
journalctl -u sakura-backend -f -n 200

# Nginx logs
sudo tail -f /var/log/nginx/access.log /var/log/nginx/error.log

# Health check
curl -s http://127.0.0.1:4000/health | jq
```

## 9) Backups

- Database: `backend/runtime/data/sakura.db` (SQLite). Back it up periodically.
- Uploads: `backend/runtime/uploads`. Sync to object storage or another server.

Example rsync (from server):

```bash
rsync -avz /home/app/apps/sakura-konveksi/backend/runtime/ user@backup:/backups/sakura-runtime/
```

## 10) Optional: PM2 instead of systemd

```bash
sudo npm i -g pm2
pm2 start backend/dist/server.js --name sakura-backend --update-env
pm2 save
pm2 startup systemd
```

---

If you need a Docker setup later, we can add a Dockerfile + docker-compose.yml with Nginx + backend and volumes for data/uploads.
